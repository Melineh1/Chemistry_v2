<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chemistry Practice</title>
  <style>
    :root{
      --bg1:#11998e; --bg2:#38ef7d;
      --ink:#1b1f23; --muted:#5b6670;
      --card:#ffffff; --soft:#f6f8fa;
      --accent:#11998e; --warn:#ffc107;
      --okbg:#d4edda; --ok:#155724; --okbd:#c3e6cb;
      --badbg:#f8d7da; --bad:#721c24; --badbd:#f5c6cb;
      --react:#e7f3ff; --prod:#eafff1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      color:var(--ink);
    }
    .container{
      max-width:980px; margin:0 auto;
      background:var(--card);
      border-radius:16px;
      box-shadow:0 12px 44px rgba(0,0,0,.20);
      padding:22px;
    }
    header{
      display:flex; flex-direction:column; gap:6px;
      align-items:center; text-align:center;
      margin-bottom:12px;
    }
    h1{margin:0; font-size:2rem; color:var(--accent); letter-spacing:.2px;}
    .sub{margin:0; color:var(--muted); font-size:1rem;}
    .pillrow{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:8px;}
    .pill{
      background:var(--soft);
      border:1px solid #e6eaef;
      padding:8px 10px;
      border-radius:999px;
      font-size:.92rem;
      display:flex; align-items:center; gap:8px;
    }
    .pill b{color:var(--accent)}
    .row{display:flex; gap:16px; flex-wrap:wrap;}
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
      margin-top:12px;
    }
    .cardbtn{
      text-align:left;
      border:2px solid #e6eaef;
      background:var(--card);
      border-radius:14px;
      padding:14px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      min-height:86px;
    }
    .cardbtn:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.08); border-color:#cfe7e4;}
    .cardbtn:active{transform:none}
    .cardbtn .title{font-size:1.08rem; font-weight:800; margin:0 0 6px 0; color:#123;}
    .cardbtn .desc{margin:0; color:var(--muted); font-size:.95rem; line-height:1.25rem;}
    .primary{
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:white;
      border:none;
      padding:12px 18px;
      border-radius:10px;
      font-size:1rem;
      font-weight:800;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .primary:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(17,153,142,.35);}
    .secondary{
      background:#6c757d;
      color:white;
      border:none;
      padding:12px 18px;
      border-radius:10px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
    }
    .ghost{
      background:transparent;
      border:2px solid #e6eaef;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      color:#234;
    }
    .screen{display:none}
    .screen.active{display:block}
    .practiceTop{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      margin-top:8px;
      padding:10px;
      border-radius:12px;
      background:var(--soft);
      border:1px solid #e6eaef;
    }
    .practiceTop .left{display:flex; flex-direction:column; gap:4px;}
    .practiceTop .mode{font-weight:900; color:#123;}
    .practiceTop .progress{color:var(--muted); font-size:.95rem;}
    .practiceTop .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    label.chk{display:flex; align-items:center; gap:8px; font-weight:700; color:#234; font-size:.95rem;}
    input[type="checkbox"]{width:18px; height:18px; cursor:pointer;}
    .questionCard{
      margin-top:12px;
      border-radius:14px;
      border:1px solid #e6eaef;
      background:var(--card);
      padding:14px;
    }
    .qPrompt{
      font-size:1.10rem;
      font-weight:800;
      margin:0 0 10px 0;
      color:#123;
      line-height:1.35rem;
    }
    .eqBox{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:1.15rem;
      background:var(--soft);
      border:1px solid #e6eaef;
      padding:12px;
      border-radius:10px;
      overflow-x:auto;
    }
    .hintRow{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .hintBtn{
      background:var(--warn);
      border:none;
      color:#222;
      font-weight:900;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
    }
    .hint{
      display:none;
      background:#fff3cd;
      border:1px solid var(--warn);
      padding:12px;
      border-radius:10px;
      margin-top:10px;
      color:#6b5b2a;
      line-height:1.25rem;
    }
    .hint.show{display:block}
    .answerArea{margin-top:12px;}
    .answerRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .answerRow input[type="number"]{
      font-size:1.15rem;
      padding:12px 12px;
      border-radius:10px;
      border:2px solid #d5dbe1;
      width:180px;
    }
    .answerRow input[type="number"]:focus{
      outline:none; border-color:var(--accent);
    }
    .units{color:var(--muted); font-weight:700;}
    .balanceWrap{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:12px;
    }
    .side{
      border-radius:12px;
      padding:12px;
      border:1px solid #e6eaef;
    }
    .side.reactants{background:var(--react)}
    .side.products{background:var(--prod)}
    .side h3{margin:0 0 8px 0; font-size:1rem; color:#123;}
    .compoundRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin:10px 0;
    }
    .compoundRow input{
      width:92px;
      font-size:1.15rem;
      padding:10px 10px;
      border-radius:10px;
      border:2px solid #d5dbe1;
    }
    .compoundRow input:focus{outline:none; border-color:var(--accent);}
    .plus{font-weight:900; color:#234; margin-left:4px;}
    .arrow{
      text-align:center;
      font-weight:900;
      font-size:1.2rem;
      color:#234;
      margin:4px 0;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
      margin-top:12px;
    }
    .feedback{
      display:none;
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      font-weight:900;
      line-height:1.25rem;
    }
    .feedback.ok{display:block; background:var(--okbg); color:var(--ok); border:1px solid var(--okbd);}
    .feedback.bad{display:block; background:var(--badbg); color:var(--bad); border:1px solid var(--badbd);}
    .steps{
      margin-top:8px;
      font-weight:700;
      color:#233;
      line-height:1.25rem;
    }
    .summary{
      margin-top:12px;
      border-radius:14px;
      border:1px solid #e6eaef;
      background:var(--soft);
      padding:14px;
    }
    .summary h2{margin:0 0 8px 0; color:var(--accent);}
    .bigScore{
      font-size:2.2rem;
      font-weight:1000;
      color:#0b7b70;
      margin:6px 0 8px 0;
    }
    .note{color:var(--muted); margin:0; line-height:1.25rem;}
    .footerRow{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      color:var(--muted);
      font-size:.92rem;
    }

    /* Subscripts in formulas */
    .chem sub{font-size:.75em; vertical-align:baseline; position:relative; bottom:-0.2em;}

    .navbtn{
      background:#0d6efd;
      color:white;
      border:none;
      padding:12px 18px;
      border-radius:10px;
      font-size:1rem;
      font-weight:800;
      cursor:pointer;
    }
    .navbtn:hover{filter:brightness(0.95)}
    .coef-ok{
      border-color: #198754 !important;
      background: #ecf8f1;
    }
    .coef-bad{
      border-color: #dc3545 !important;
      background: #fff1f2;
    }
    .coef-mark{
      font-weight:1000;
      margin-left:6px;
    }
    .coef-mark.ok{color:#198754}
    .coef-mark.bad{color:#dc3545}

    /* single-line balancing layout */
    .balanceLine{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid #e6eaef;
      background: var(--soft);
      overflow-x:auto;
    }
    .piece{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:nowrap;
      white-space:nowrap;
    }
    .piece input{
      width:86px;
      font-size:1.15rem;
      padding:10px 10px;
      border-radius:10px;
      border:2px solid #d5dbe1;
    }
    .piece input:focus{outline:none; border-color:var(--accent);}
    .op{font-weight:1000; color:#234; margin:0 4px;}

    @media (max-width:720px){
      .container{padding:16px}
      h1{font-size:1.7rem}
      .grid{grid-template-columns:1fr}
      .answerRow input[type="number"]{width:100%}
      .compoundRow input{width:104px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="titleTap">Chemistry Practice</h1>
      <p class="sub">One question at a time â€¢ fast feedback â€¢ phone-friendly</p>
      <div class="pillrow" id="pillrow" style="display:none;">
        <div class="pill">Set score: <b id="setScore">0 / 0</b></div>
        <div class="pill">First-try accuracy: <b id="setAcc">0%</b></div>
        <div class="pill">Overall accuracy: <b id="setAccAll">0%</b></div>
      </div>
    </header>

    <!-- HOME -->
    <section class="screen active" id="homeScreen">
      <p style="margin:0; color:var(--muted); line-height:1.35rem;">
        Pick a practice type. Youâ€™ll get <b>5 questions</b>. Results show at the end.
      </p>

      <div class="grid" style="margin-top:14px;">
        <button class="cardbtn" onclick="startPractice('balancing')">
          <p class="title">Balancing equations</p>
          <p class="desc">Enter coefficients. Lowest whole-number ratio expected.</p>
        </button>

        <button class="cardbtn" onclick="startPractice('mole-to-mole')">
          <p class="title">Mole ratio</p>
          <p class="desc">Moles of reactant â†’ moles of product using the balanced equation.</p>
        </button>

        <button class="cardbtn" onclick="startPractice('mole-to-mass')">
          <p class="title">Mole â†’ mass</p>
          <p class="desc">Moles of reactant â†’ grams of product using molar mass + mole ratio.</p>
        </button>

        <button class="cardbtn" onclick="startPractice('mass-to-mass')">
          <p class="title">Mass â†’ mass</p>
          <p class="desc">Grams of reactant â†’ grams of product using molar mass + mole ratio.</p>
        </button>
      </div>

      <div class="footerRow" style="margin-top:16px;">
        <span>Tip: Use the hint if you get stuck.</span>
        <button class="ghost" onclick="showQuickHelp()">Quick help</button>
      </div>

      <div id="quickHelp" class="hint" style="display:none; margin-top:12px;">
        <b>Balancing:</b> count atoms on each side; start with the most complex compound.<br>
        <b>Stoichiometry:</b> use the mole ratio from the balanced equation; convert with molar mass when needed.
      </div>
    </section>

    <!-- PRACTICE -->
    <section class="screen" id="practiceScreen">
      <div class="practiceTop">
        <div class="left">
          <div class="mode" id="modeLabel">Practice</div>
          <div class="progress" id="progressLabel">Question 1 of 5</div>
        </div>
        <div class="right">
<button class="navbtn" onclick="backToHome()">Main menu</button>
        </div>
      </div>

      <div class="questionCard" id="questionCard"></div>

      <div class="actions" id="actionRow">
        <button class="primary" id="submitBtn" onclick="submitAnswer()">Submit</button>
        <button class="secondary" id="tryAgainBtn" onclick="tryAgain()" style="display:none;">Try again</button>
        <button class="secondary" id="nextBtn" onclick="nextQuestion()" style="display:none;">Next</button>
        <button class="ghost" onclick="restartSet()">Restart set</button>
      </div>

      <div class="feedback" id="feedbackBox"></div>
    </section>

    <!-- SUMMARY -->
    <section class="screen" id="summaryScreen">
      <div class="summary">
        <h2>Set results</h2>
        <div class="bigScore" id="finalScore">0 / 5</div>
        <p class="note" id="finalNote">Accuracy: 0%</p>
      </div>
      <div class="actions">
        <button class="primary" onclick="restartSet()">Practice again (same type)</button>
        <button class="ghost" onclick="backToHome()">Pick a different type</button>
      </div>
    </section>
  </div>

<script>
/* -------------------------------
   DATA: atomic masses + reactions
-------------------------------- */
const atomicMasses = {
  H: 1.008, He: 4.003, C: 12.011, N: 14.007, O: 15.999, F: 19.00, Ne: 20.18,
  Na: 22.990, Mg: 24.305, Al: 26.982, Si: 28.086, P: 30.974, S: 32.06, Cl: 35.453,
  K: 39.098, Ca: 40.078, Fe: 55.845, Cu: 63.546, Zn: 65.38, Ag: 107.868, Ba: 137.327,
  Cr: 51.996
};

const reactionPools = {
  easy: [
    { reactants: ['2H2','O2'], products: ['2H2O'], type: 'synthesis' },
    { reactants: ['CH4','2O2'], products: ['CO2','2H2O'], type: 'combustion' },
    { reactants: ['2Na','Cl2'], products: ['2NaCl'], type: 'synthesis' },
    { reactants: ['Zn','2HCl'], products: ['ZnCl2','H2'], type: 'single replacement' },
    { reactants: ['HCl','NaOH'], products: ['NaCl','H2O'], type: 'double replacement' }
  ],
  medium: [
    { reactants: ['2KClO3'], products: ['2KCl','3O2'], type: 'decomposition' },
    { reactants: ['2Al','3Cl2'], products: ['2AlCl3'], type: 'synthesis' },
    { reactants: ['BaCl2','Na2SO4'], products: ['2NaCl','BaSO4'], type: 'double replacement' },
    { reactants: ['C3H8','5O2'], products: ['3CO2','4H2O'], type: 'combustion' },
    { reactants: ['Cu','2AgNO3'], products: ['Cu(NO3)2','2Ag'], type: 'single replacement' }
  ],
  hard: [
    { reactants: ['Fe2O3','3CO'], products: ['2Fe','3CO2'], type: 'single replacement' },
    { reactants: ['2Na3PO4','3CaCl2'], products: ['Ca3(PO4)2','6NaCl'], type: 'double replacement' },
    { reactants: ['2Al(OH)3'], products: ['Al2O3','3H2O'], type: 'decomposition' },
    { reactants: ['2C2H6','7O2'], products: ['4CO2','6H2O'], type: 'combustion' },
    { reactants: ['FeCl3','3NaOH'], products: ['Fe(OH)3','3NaCl'], type: 'double replacement' }
  ],
  evil: [
    { reactants: ['2Fe2(SO4)3','6H2O'], products: ['4Fe(OH)3','6H2SO4'], type: 'double replacement' },
    { reactants: ['(NH4)2Cr2O7'], products: ['Cr2O3','N2','4H2O'], type: 'decomposition' },
    { reactants: ['2Al','3CuSO4'], products: ['Al2(SO4)3','3Cu'], type: 'single replacement' },
    { reactants: ['CaCO3','2HCl'], products: ['CaCl2','H2O','CO2'], type: 'double replacement' },
    { reactants: ['4NH3','5O2'], products: ['4NO','6H2O'], type: 'combustion' }
  ]
};

function pickOne(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* -------------------------------
   CHEM HELPERS
-------------------------------- */
function escapeHtml(str) {
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#39;");
}
function formatFormulaHTML(s){
  // subscript digits after element or ')'
  return String(s).replace(/([A-Za-z\)])(\d+)/g,'$1<sub>$2</sub>');
}
function formatEquationHTML(eq){ return formatFormulaHTML(eq); }

function calcMolarMass(formula){
  let i = 0;
  function parseGroup(){
    const counts = {};
    while(i < formula.length){
      const ch = formula[i];
      if(ch === '('){
        i++;
        const inner = parseGroup();
        i++; // ')'
        const mult = parseNum() || 1;
        for(const el in inner) counts[el] = (counts[el]||0) + inner[el]*mult;
        continue;
      }
      if(ch === ')') break;
      const el = parseEl();
      const n = parseNum() || 1;
      counts[el] = (counts[el]||0) + n;
    }
    return counts;
  }
  function parseEl(){
    let el = formula[i++];
    if(i < formula.length && /[a-z]/.test(formula[i])) el += formula[i++];
    return el;
  }
  function parseNum(){
    let s = i;
    while(i < formula.length && /\d/.test(formula[i])) i++;
    return s === i ? null : parseInt(formula.slice(s,i),10);
  }
  const counts = parseGroup();
  let mass = 0;
  for(const el in counts){
    if(!atomicMasses[el]) throw new Error('Unknown element: ' + el);
    mass += atomicMasses[el] * counts[el];
  }
  return mass;
}

/* -------------------------------
   APP STATE
-------------------------------- */
const app = {
  firstCorrect: 0,
  firstAttempts: 0,
  totalSubmissions: 0,
  totalCorrectSubmissions: 0,
  setQuestions: [],
  usedEq: new Set(),
  practiceType: null, // 'balancing' | 'mole-to-mole' | 'mole-to-mass' | 'mass-to-mass'
  setSize: 25,
  qIndex: 0,
  correct: 0,
  current: null,
  showSteps: false
};

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showQuickHelp(){
  const el = document.getElementById('quickHelp');
  el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
}

function backToHome(){
  showScreen('homeScreen');
  document.getElementById('pillrow').style.display = 'none';
}

function startPractice(type){
  app.practiceType = type;
  restartSet(true);
}

function restartSet(fromStart=false){
  if(!app.practiceType && !fromStart){
    backToHome(); return;
  }
  app.qIndex = 0;
  app.correct = 0;
  app.firstCorrect = 0;
  app.firstAttempts = 0;
  app.totalSubmissions = 0;
  app.totalCorrectSubmissions = 0;
  app.current = null;
  document.getElementById('feedbackBox').className = 'feedback';
  document.getElementById('feedbackBox').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('tryAgainBtn').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').textContent = 'Next';
  document.getElementById('pillrow').style.display = 'none';

  // label
  const labelMap = {
    'balancing': 'Balancing equations',
    'mole-to-mole': 'Mole ratio',
    'mole-to-mass': 'Mole â†’ mass',
    'mass-to-mass': 'Mass â†’ mass'
  };
  document.getElementById('modeLabel').textContent = labelMap[app.practiceType] || 'Practice';

  showScreen('practiceScreen');

  // build a full set up-front to enforce no repeats
  app.setQuestions = buildSetQuestions(app.practiceType, app.setSize);
  nextQuestion(true);
}

document.getElementById('showStepsChk').addEventListener('change', (e) => {
  app.showSteps = !!e.target.checked;
  // if feedback already shown, re-render it with/without steps
  if(app.current && app.current._lastFeedback){
    renderFeedback(app.current._lastFeedback.ok, app.current._lastFeedback.message, app.current._lastFeedback.stepsHtml);
  }
});

/* -------------------------------
   QUESTION GENERATION (1 at a time)
-------------------------------- */
function getReactionForStoich(){
  // based on practice type, widen pools a bit
  const pools = (app.practiceType === 'mass-to-mass')
    ? ['medium','hard','evil']
    : (app.practiceType === 'mole-to-mass')
      ? ['easy','medium','hard']
      : ['easy','medium'];
  const bag = [];
  pools.forEach(k => bag.push(...reactionPools[k]));
  return pickOne(bag);
}

/* -------------------------------
   BALANCING GENERATOR (Template-based)
-------------------------------- */

// element pools (common HS chemistry symbols)
const METALS = ['Na','Mg','Al','K','Ca','Fe','Cu','Zn'];
const NONMETALS = ['H','C','N','O','S','Cl','F'];

// helper: random pick
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function pickDistinct(arr, disallow){
  let x = pick(arr);
  while(disallow.has(x)) x = pick(arr);
  return x;
}

// parse a simple chemical formula (no parentheses)
function parseFormula(formula){
  const counts = {};
  const reEl = /([A-Z][a-z]?)(\d*)/g;
  let m;
  while((m = reEl.exec(formula)) !== null){
    const el = m[1];
    const n = m[2] ? parseInt(m[2],10) : 1;
    counts[el] = (counts[el]||0) + n;
  }
  return counts;
}
function unionElements(compounds){
  const s = new Set();
  compounds.forEach(f=>{
    const c = parseFormula(f);
    Object.keys(c).forEach(k=>s.add(k));
  });
  return Array.from(s);
}
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ const t=a%b; a=b; b=t; } return a||1; }
function gcdAll(arr){ return arr.reduce((g,x)=>gcd(g,x),0); }

// brute-force balance search (small equations)
function balanceBruteforce(reactants, products, maxCoef=12){
  const comps = reactants.concat(products);
  const elems = unionElements(comps);
  const rc = reactants.map(parseFormula);
  const pc = products.map(parseFormula);

  const nR = reactants.length;
  const nP = products.length;
  const n = nR + nP;

  const coeffs = new Array(n).fill(1);

  function okWithCoeffs(){
    for(const el of elems){
      let left = 0, right = 0;
      for(let i=0;i<nR;i++) left += (rc[i][el]||0) * coeffs[i];
      for(let j=0;j<nP;j++) right += (pc[j][el]||0) * coeffs[nR+j];
      if(left !== right) return false;
    }
    return true;
  }

  // fix first coefficient to 1 to reduce equivalent solutions
  coeffs[0] = 1;

  function dfs(idx){
    if(idx === n){
      return okWithCoeffs() ? coeffs.slice() : null;
    }
    for(let v=1; v<=maxCoef; v++){
      coeffs[idx] = v;
      const res = dfs(idx+1);
      if(res) return res;
    }
    return null;
  }

  const res = dfs(1);
  if(!res) return null;

  const g = gcdAll(res);
  return res.map(x=>x/g);
}

// Build a plausible template reaction, then balance it
function makeTemplateReaction(){
  const template = Math.floor(Math.random()*6); // 0..5

  // combustion: CxHy + O2 -> CO2 + H2O
  if(template === 4){
    const x = Math.floor(Math.random()*4)+1; // 1..4
    const y = (Math.floor(Math.random()*4)+1)*2; // even 2..8
    const hydro = `C${x===1?'':x}H${y===1?'':y}`;
    return { reactants:[hydro, 'O2'], products:['CO2','H2O'] };
  }

  // acid-base: HA + BOH -> BA + H2O (monoprotic / monohydroxide)
  if(template === 5){
    const A = pickDistinct(NONMETALS, new Set(['H','O']));
    const B = pick(METALS);
    const acid = `H${A}`;
    const base = `${B}OH`;
    const salt = `${B}${A}`;
    return { reactants:[acid, base], products:[salt, 'H2O'] };
  }

  // synthesis: A + B -> A_mB_n
  if(template === 0){
    const A = pick(METALS);
    const B = pickDistinct(NONMETALS, new Set(['H','C','N']));
    const m = Math.floor(Math.random()*3)+1;
    const n = Math.floor(Math.random()*3)+1;
    const prod = `${A}${m===1?'':m}${B}${n===1?'':n}`;
    return { reactants:[A, B], products:[prod] };
  }

  // decomposition: AB -> A + B
  if(template === 1){
    const A = pick(METALS);
    const B = pickDistinct(NONMETALS, new Set(['C','N']));
    const m = Math.floor(Math.random()*3)+1;
    const n = Math.floor(Math.random()*3)+1;
    const comp = `${A}${m===1?'':m}${B}${n===1?'':n}`;
    return { reactants:[comp], products:[A, B] };
  }

  // single replacement: A + BC -> AC + B
  if(template === 2){
    const A = pick(METALS);
    const B = pickDistinct(METALS, new Set([A]));
    const C = pickDistinct(NONMETALS, new Set(['H','C','N']));
    const bSub = Math.floor(Math.random()*3)+1;
    const cSub = Math.floor(Math.random()*3)+1;
    const BC = `${B}${bSub===1?'':bSub}${C}${cSub===1?'':cSub}`;
    const aSub = Math.floor(Math.random()*3)+1;
    const AC = `${A}${aSub===1?'':aSub}${C}${cSub===1?'':cSub}`;
    return { reactants:[A, BC], products:[AC, B] };
  }

  // double replacement: AB + CD -> AD + CB
  const A = pick(METALS);
  const C = pickDistinct(METALS, new Set([A]));
  const B = pickDistinct(NONMETALS, new Set(['H','C','N']));
  const D = pickDistinct(NONMETALS, new Set(['H','C','N',B]));
  const aSub = Math.floor(Math.random()*3)+1;
  const bSub = Math.floor(Math.random()*3)+1;
  const cSub = Math.floor(Math.random()*3)+1;
  const dSub = Math.floor(Math.random()*3)+1;
  const AB = `${A}${aSub===1?'':aSub}${B}${bSub===1?'':bSub}`;
  const CD = `${C}${cSub===1?'':cSub}${D}${dSub===1?'':dSub}`;
  const AD = `${A}${aSub===1?'':aSub}${D}${dSub===1?'':dSub}`;
  const CB = `${C}${cSub===1?'':cSub}${B}${bSub===1?'':bSub}`;
  return { reactants:[AB, CD], products:[AD, CB] };
}

function generateBalancedReaction(){
  for(let tries=0; tries<200; tries++){
    const rxn = makeTemplateReaction();
    const coeffs = balanceBruteforce(rxn.reactants, rxn.products, 12);
    if(!coeffs) continue;
    if(coeffs.some(c=>c>10)) continue;

    const nR = rxn.reactants.length;
    const rWith = rxn.reactants.map((f,i)=>`${coeffs[i]}${f}`);
    const pWith = rxn.products.map((f,i)=>`${coeffs[nR+i]}${f}`);

    return { reactants:rWith, products:pWith, plainReactants:rxn.reactants, plainProducts:rxn.products, coeffs };
  }
  return { reactants:['2H2','1O2'], products:['2H2O'], plainReactants:['H2','O2'], plainProducts:['H2O'], coeffs:[2,1,2] };
}

function generateBalancingQuestion(){
  const reaction = generateBalancedReaction();

  const reactants = reaction.plainReactants.slice();
  const products  = reaction.plainProducts.slice();
  const correctCoeffs = reaction.coeffs.slice();

  const eqPlain = reactants.join(' + ') + ' \u2192 ' + products.join(' + ');
  const eqHTML = formatEquationHTML(eqPlain);

  return {
    type:'balancing',
    reactants, products,
    allCompounds: reactants.concat(products),
    eqHTML,
    answer: correctCoeffs,
    steps: `Balanced equation: ${reaction.reactants.join(' + ')} â†’ ${reaction.products.join(' + ')}`,
    hintHtml: `<b>Tip:</b> Count atoms on each side.<br><b>Strategy:</b> Start with the most complex compound.`
  };
}

function buildSetQuestions(practiceType, size){
  const out = [];
  const localUsed = new Set();

  if(practiceType === 'balancing'){
    let guard = 0;
    while(out.length < size && guard < 5000){
      guard++;
      const q = generateBalancingQuestion();
      const key = q.reactants.join('+') + '->' + q.products.join('+');
      if(localUsed.has(key)) continue;
      if(app.usedEq.has(key)) continue;

      localUsed.add(key);
      app.usedEq.add(key);
      out.push(q);

      if(app.usedEq.size > 800) app.usedEq.clear();
    }
    while(out.length < size){
      const q = generateBalancingQuestion();
      const key = q.reactants.join('+') + '->' + q.products.join('+');
      if(localUsed.has(key)) continue;
      localUsed.add(key);
      out.push(q);
    }
    return out;
  }

  let guard = 0;
  while(out.length < size && guard < 5000){
    guard++;
    const q = generateStoichQuestion(practiceType);
    const key = q.prompt || q.eqHTML || JSON.stringify(q);
    if(localUsed.has(key)) continue;
    localUsed.add(key);
    out.push(q);
  }
  while(out.length < size){
    out.push(generateStoichQuestion(practiceType));
  }
  return out;
}


/* -------------------------------
   RENDER
-------------------------------- */
function renderQuestion(q){
  const card = document.getElementById('questionCard');
  const feedback = document.getElementById('feedbackBox');
  feedback.className = 'feedback';
  feedback.style.display = 'none';

  document.getElementById('progressLabel').textContent = `Question ${app.qIndex+1} of ${app.setSize}`;

  if(q.type === 'stoich'){
    card.innerHTML = `
      <div class="qPrompt">${q.promptHtml}</div>
      <div class="eqBox chem">${q.eqHTML}</div>

      <div class="hintRow">
        <button class="hintBtn" onclick="toggleHint()">ðŸ’¡ Hint</button>
        <span style="color:var(--muted); font-weight:700;">Use the balanced equation.</span>
      </div>
      <div class="hint" id="hintBox">${q.hintHtml}</div>

      <div class="answerArea">
        <div class="answerRow">
          <input type="number" step="0.01" id="stoichAnswer" inputmode="decimal" placeholder="Type your answer" />
          <span class="units">${q.unitsHtml}</span>
        </div>
      </div>
    `;
    setTimeout(()=>document.getElementById('stoichAnswer')?.focus(), 50);
  } else {
    // balancing: single-line equation layout (linear reading)
    const parts = [];
    q.reactants.forEach((c,i) => {
      parts.push(`
        <span class="piece">
          <input type="number" min="1" step="1" inputmode="numeric" id="coef_r_${i}" placeholder="Coeff" />
          <span class="chem">${formatEquationHTML(c)}</span>
          <span class="coef-mark" id="mark_r_${i}" style="display:none;"></span>
        </span>
      `);
      if(i < q.reactants.length-1) parts.push(`<span class="op">+</span>`);
    });

    parts.push(`<span class="op">â†’</span>`);

    q.products.forEach((c,i) => {
      parts.push(`
        <span class="piece">
          <input type="number" min="1" step="1" inputmode="numeric" id="coef_p_${i}" placeholder="Coeff" />
          <span class="chem">${formatEquationHTML(c)}</span>
          <span class="coef-mark" id="mark_p_${i}" style="display:none;"></span>
        </span>
      `);
      if(i < q.products.length-1) parts.push(`<span class="op">+</span>`);
    });

    card.innerHTML = `
      <div class="qPrompt">Balance this equation (enter coefficients):</div>
      <div class="eqBox chem">${q.eqHTML}</div>

      <div class="hintRow">
        <button class="hintBtn" onclick="toggleHint()">ðŸ’¡ Hint</button>
        <span style="color:var(--muted); font-weight:700;">Lowest whole-number ratio expected.</span>
      </div>
      <div class="hint" id="hintBox">${q.hintHtml}</div>

      <div class="balanceLine" aria-label="Coefficient inputs">
        ${parts.join('')}
      </div>
    `;
    setTimeout(()=>document.getElementById('coef_r_0')?.focus(), 50);
  }
}

function toggleHint(){
  const el = document.getElementById('hintBox');
  if(el) el.classList.toggle('show');
}


function setBalancingInputsDisabled(q, disabled){
  if(!q || q.type !== 'balancing') return;
  for(let i=0;i<q.reactants.length;i++){
    const inp = document.getElementById(`coef_r_${i}`);
    if(inp) inp.disabled = disabled;
  }
  for(let i=0;i<q.products.length;i++){
    const inp = document.getElementById(`coef_p_${i}`);
    if(inp) inp.disabled = disabled;
  }
}

function clearBalancingMarks(q){
  if(!q || q.type !== 'balancing') return;
  for(let i=0;i<q.reactants.length;i++){
    const inp = document.getElementById(`coef_r_${i}`);
    const mk  = document.getElementById(`mark_r_${i}`);
    if(inp){ inp.classList.remove('coef-ok','coef-bad'); }
    if(mk){ mk.style.display='none'; mk.textContent=''; mk.className='coef-mark'; }
  }
  for(let i=0;i<q.products.length;i++){
    const inp = document.getElementById(`coef_p_${i}`);
    const mk  = document.getElementById(`mark_p_${i}`);
    if(inp){ inp.classList.remove('coef-ok','coef-bad'); }
    if(mk){ mk.style.display='none'; mk.textContent=''; mk.className='coef-mark'; }
  }
}

function tryAgain(){
  const fb = document.getElementById('feedbackBox');
  fb.className = 'feedback';
  fb.style.display = 'none';

  clearBalancingMarks(app.current);
  setBalancingInputsDisabled(app.current, false);

  document.getElementById('tryAgainBtn').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'inline-block';

  if(app.current?.type === 'balancing'){
    document.getElementById('coef_r_0')?.focus();
  }else{
    document.getElementById('stoichAnswer')?.focus();
  }
}

function renderFeedback(ok, message, stepsHtml=''){
  const fb = document.getElementById('feedbackBox');
  fb.className = ok ? 'feedback good' : 'feedback bad';
  let html = message;
  if(stepsHtml && stepsHtml.trim().length){
    html += `<div class="steps">${stepsHtml}</div>`;
  }
  fb.innerHTML = html;
  fb.style.display = 'block';
}

function updatePills(){
  document.getElementById('pillrow').style.display = 'flex';
  document.getElementById('setScore').textContent = `${app.correct} / ${app.qIndex}`;

  const firstAcc = app.firstAttempts > 0
    ? Math.round((app.firstCorrect / app.firstAttempts) * 100)
    : 0;
  document.getElementById('setAcc').textContent = `${firstAcc}%`;

  const overallAcc = app.totalSubmissions > 0
    ? Math.round((app.totalCorrectSubmissions / app.totalSubmissions) * 100)
    : 0;
  document.getElementById('setAccAll').textContent = `${overallAcc}%`;
}

/* -------------------------------
   FLOW
-------------------------------- */
function nextQuestion(isFirst=false){
  if(app.qIndex >= app.setSize){
    showSummary();
    return;
  }

  document.getElementById('nextBtn').style.display = 'none';
  document.getElementById('tryAgainBtn').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').textContent = 'Next';

  app.current = app.setQuestions[app.qIndex];
  app.current._lastFeedback = null;

  renderQuestion(app.current);
  clearBalancingMarks(app.current);
  setBalancingInputsDisabled(app.current, false);

  if(!isFirst){
    if(app.qIndex >= 1) updatePills();
  }
}

function submitAnswer(){
  const q = app.current;
  if(!q) return;

  app.totalSubmissions++;

  // FIRST-TRY ACCURACY: count only the first time they submit on this question
  const isFirstAttempt = !q._attempted;
  if(isFirstAttempt){
    app.firstAttempts++;
    q._attempted = true;
  }

  // STOICHIOMETRY: one attempt per question (set-based)
  if(q.type === 'stoich'){
    const input = document.getElementById('stoichAnswer');
    const user = parseFloat(input?.value);
    if(Number.isNaN(user)){
      renderFeedback(false, 'Enter a number to submit.');
      return;
    }
    const tol = q.tol ?? 0.5;
    const ok = Math.abs(user - q.answer) <= tol;
    const msg = ok ? 'âœ“ Correct!' : 'âœ— Not quite.';
    const steps = `${escapeHtml(q.steps)}<br><span style="color:var(--muted);">Accepted if within rounding tolerance (Â±${tol.toFixed(2)})</span>`;
    q._lastFeedback = {ok, message: msg, stepsHtml: steps};
    renderFeedback(ok, msg, steps);

    if(ok){
      app.correct++;
      app.totalCorrectSubmissions++;
      if(isFirstAttempt) app.firstCorrect++;
    }

    // advance to next question in the set
    app.qIndex++;
    updatePills();

    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('tryAgainBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'inline-block';
    document.getElementById('nextBtn').textContent = (app.qIndex >= app.setSize) ? 'View results' : 'Next';
    return;
  }

  // BALANCING: attempt loop with max 3 attempts; lock inputs after submit
  q._attemptCount = (q._attemptCount || 0) + 1;

  clearBalancingMarks(q);

  const correctness = [];
  const userCoeffs = [];

  // reactants first
  for(let i=0;i<q.reactants.length;i++){
    const el = document.getElementById(`coef_r_${i}`);
    const val = parseInt(el?.value, 10);
    if(Number.isNaN(val) || val < 1){
      renderFeedback(false, 'Fill in all coefficients with whole numbers â‰¥ 1.');
      return;
    }
    userCoeffs.push(val);
    const isOk = val === q.answer[i];
    correctness.push(isOk);

    const mk = document.getElementById(`mark_r_${i}`);
    if(el){ el.classList.add(isOk ? 'coef-ok' : 'coef-bad'); }
    if(mk){
      mk.style.display = 'inline';
      mk.textContent = isOk ? 'âœ“' : 'âœ—';
      mk.classList.add(isOk ? 'ok' : 'bad');
    }
  }

  // then products
  for(let i=0;i<q.products.length;i++){
    const el = document.getElementById(`coef_p_${i}`);
    const val = parseInt(el?.value, 10);
    if(Number.isNaN(val) || val < 1){
      renderFeedback(false, 'Fill in all coefficients with whole numbers â‰¥ 1.');
      return;
    }
    userCoeffs.push(val);
    const idx = q.reactants.length + i;
    const isOk = val === q.answer[idx];
    correctness.push(isOk);

    const mk = document.getElementById(`mark_p_${i}`);
    if(el){ el.classList.add(isOk ? 'coef-ok' : 'coef-bad'); }
    if(mk){
      mk.style.display = 'inline';
      mk.textContent = isOk ? 'âœ“' : 'âœ—';
      mk.classList.add(isOk ? 'ok' : 'bad');
    }
  }

  const numOk = correctness.filter(Boolean).length;
  const total = correctness.length;
  const allOk = numOk === total;

  // lock inputs after submit (prevents editing during feedback state)
  setBalancingInputsDisabled(q, true);

  if(allOk){
    const msg = 'âœ“ Correct!';
    const steps = `${escapeHtml(q.steps)}`;
    q._lastFeedback = {ok:true, message: msg, stepsHtml: steps};
    renderFeedback(true, msg, steps);

    app.correct++;
    app.totalCorrectSubmissions++;
    if(isFirstAttempt) app.firstCorrect++;

    app.qIndex++;
    updatePills();

    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('tryAgainBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'inline-block';
    document.getElementById('nextBtn').textContent = (app.qIndex >= app.setSize) ? 'View results' : 'Next';
    return;
  }

  // not correct, attempts 1-2
  if(q._attemptCount < 3){
    const msg = `âœ— Not yet. ${numOk} of ${total} coefficients are correct.`;
    q._lastFeedback = {ok:false, message: msg, stepsHtml: ''};
    renderFeedback(false, msg, '');

    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('tryAgainBtn').style.display = 'inline-block';
    return;
  }

  // attempt 3 and still not correct: review mode (no partial summary)
  const coefText = (n)=> (n===1 ? '' : String(n));

  function buildEqHTML(coeffs){
    const pieces = [];
    // reactants
    q.reactants.forEach((c,i)=>{
      pieces.push(`${coefText(coeffs[i])}${formatEquationHTML(c)}`);
      if(i<q.reactants.length-1) pieces.push(' + ');
    });
    pieces.push(' â†’ ');
    // products
    q.products.forEach((c,i)=>{
      const idx = q.reactants.length + i;
      pieces.push(`${coefText(coeffs[idx])}${formatEquationHTML(c)}`);
      if(i<q.products.length-1) pieces.push(' + ');
    });
    return pieces.join('');
  }

  const userEq = buildEqHTML(userCoeffs);
  const correctEq = buildEqHTML(q.answer);

  const reviewHtml = `
    <div style="font-weight:1000; margin-top:6px;">You said this:</div>
    <div class="eqBox chem" style="margin-top:8px;">${userEq}</div>

    <div style="font-weight:1000; margin-top:12px;">This is the correct solution:</div>
    <div class="eqBox chem" style="margin-top:8px;">${correctEq}</div>
  `;

  // show review (keep inputs disabled)
  const fb = document.getElementById('feedbackBox');
  fb.className = 'feedback bad';
  fb.innerHTML = reviewHtml;
  fb.style.display = 'block';

  // advance without awarding point
  app.qIndex++;
  updatePills();

  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('tryAgainBtn').style.display = 'none';
  document.getElementById('nextBtn').style.display = 'inline-block';
  document.getElementById('nextBtn').textContent = (app.qIndex >= app.setSize) ? 'View results' : 'Next';
}

function showSummary(){
  showScreen('summaryScreen');

  const firstAcc = app.firstAttempts > 0 ? Math.round((app.firstCorrect/app.firstAttempts)*100) : 0;
  const overallAcc = app.totalSubmissions > 0 ? Math.round((app.totalCorrectSubmissions/app.totalSubmissions)*100) : 0;

  document.getElementById('finalScore').textContent = `${app.correct} / ${app.setSize}`;
  document.getElementById('finalNote').textContent = `First-try accuracy: ${firstAcc}% â€¢ Overall accuracy: ${overallAcc}% â€¢ Total submits: ${app.totalSubmissions}`;

  document.getElementById('pillrow').style.display = 'flex';
  document.getElementById('setScore').textContent = `${app.correct} / ${app.setSize}`;
  document.getElementById('setAcc').textContent = `${firstAcc}%`;
  document.getElementById('setAccAll').textContent = `${overallAcc}%`;
}

/* -------------------------------
   SMALL UX: title tap easter egg (optional)
   (kept harmless; no extra controls shown)
-------------------------------- */
let tapCount = 0;
document.getElementById('titleTap').addEventListener('click', () => {
  tapCount++;
  if(tapCount === 7){
    // enable steps by default as a hidden teacher-ish shortcut
    document.getElementById('showStepsChk').checked = true;
    app.showSteps = true;
    if(app.current && app.current._lastFeedback){
      renderFeedback(app.current._lastFeedback.ok, app.current._lastFeedback.message, app.current._lastFeedback.stepsHtml);
    }
    tapCount = 0;
  }
});
</script>
</body>
</html>
